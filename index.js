!function(t,i){"object"==typeof exports&&"object"==typeof module?module.exports=i():"function"==typeof define&&define.amd?define([],i):"object"==typeof exports?exports.SphereCollision=i():t.SphereCollision=i()}(self,(function(){return function(){"use strict";var t,i={};!function(t){t[t.waitStart=0]="waitStart",t[t.inAnimation=1]="inAnimation",t[t.stop=2]="stop"}(t||(t={}));var s=function(){function i(i,s,e,h){this.ctx=i||null,this.canvas=s||null,this.options={collisionRectX:0,collisionRectY:0,collisionRectWidth:s.width,collisionRectHeight:s.height,monitorMousePos:!1,beforeDrawGlobules:null,afterDrawGlobules:null,onMouseDownCanvas:null,onMouseMoveCanvas:null,onMouseUpCanvas:null,onMouseLeaveCanvas:null},h&&(this.options=Object.assign({},this.options,h)),this.frameId=0,this.animationState=t.waitStart,this.mousePos={mouseX:null,mouseY:null},this.prevMousePos={mouseX:null,mouseY:null},this.isMouseDown=!1,this.mouseDownPos={mouseX:null,mouseY:null};var n=[];if(e&&e.length>0)for(var r=0,a=e.length;r<a;r++){var l=e[r],u=l.id,c=l.initX,v=l.initY,f=l.vx,d=l.vy,m=l.radius,y=l.color,x=l.alpha,p=l.alphaChangeV,M=l.bgImg,b=l.collisionLossV,C=l.moveLossV,g=l.gDirection,F=l.gCoefficient,L=l.requiredMouseInteraction,P=l.mouseInteractionBehavior,V=l.fixedPos,w=l.receiveOutForce,G=l.receiveWallForce,I=l.onlyCheckCollision,O=l.maxMouseOutForce,_=l.maxMoveV,D=l.beforeDrawGlobule,X=l.afterDrawGlobule,Y=l.afterCalculateNextFrameGlobule,B=new o(i,s,u,c,v,f,d,m,y,x,p,M,b,C,g,F,L,P,V,w,G,I,O,this.mousePos,_,D,X,Y);n.push(B)}if(this.globuleList=n,this.options.monitorMousePos){var k=this;s.addEventListener("mousedown",(function(t){k._updateMouseProperty(t),k.mouseInGlobuleList.forEach((function(t){var i=t.requiredMouseInteraction,s=t.mouseInteractionBehavior;i&&"drag"===s&&(t.vx=0,t.vy=0)})),k.options.onMouseDownCanvas&&k.options.onMouseDownCanvas(t,k)})),s.addEventListener("mousemove",(function(t){k._updateMouseProperty(t),k.isMouseDown&&k.mouseInGlobuleList.forEach((function(t){var i=t.requiredMouseInteraction,s=t.mouseInteractionBehavior;if(i&&"drag"===s){var o=k.mousePos.mouseX-k.prevMousePos.mouseX,e=k.mousePos.mouseY-k.prevMousePos.mouseY;t.x+=o,t.y+=e;var h=t.receiveOutForce,n=t.maxMouseOutForce;if(h){var r=o,a=e;n&&(r>n?r=n:r<-n&&(r=-n),a>n?a=n:a<-n&&(a=-n)),t.vx=r,t.vy=a}}})),k.options.onMouseMoveCanvas&&k.options.onMouseMoveCanvas(t,k)})),s.addEventListener("mouseup",(function(t){k._updateMouseProperty(t),k.options.onMouseUpCanvas&&k.options.onMouseUpCanvas(t,k)})),s.addEventListener("mouseleave",(function(t){k._updateMouseProperty(t),k.options.onMouseLeaveCanvas&&k.options.onMouseLeaveCanvas(t,k)}))}}return i.prototype.start=function(){var i=this;this.animationState=t.inAnimation,i.frameId=requestAnimationFrame((function s(){if(i.animationState===t.inAnimation){var o=i.ctx,e=i.canvas,h=i.globuleList,n=i.options,r=n.beforeDrawGlobules,a=n.afterDrawGlobules,l=n.collisionRectX,u=n.collisionRectY,c=n.collisionRectWidth,v=n.collisionRectHeight,f=e.width,d=e.height;r?r&&r(i):o.clearRect(0,0,f,d),h.forEach((function(t,i){t._drawCurrentFrame(h,i,l,u,c,v)})),a&&a(i),h.forEach((function(t){t.inCollisionGlobule=!1,t.inCollisionGlobuleList=[],t.inCollisionWall=!1})),h.forEach((function(t,i){t._calculateNextFrame(h,i,l,u,c,v)})),i.frameId=requestAnimationFrame(s)}}))},i.prototype.createGlobule=function(t){var i=t.id,s=t.initX,e=t.initY,h=t.vx,n=t.vy,r=t.radius,a=t.color,l=t.alpha,u=t.alphaChangeV,c=t.bgImg,v=t.collisionLossV,f=t.moveLossV,d=t.gDirection,m=t.gCoefficient,y=t.requiredMouseInteraction,x=t.mouseInteractionBehavior,p=t.fixedPos,M=t.receiveOutForce,b=t.receiveWallForce,C=t.onlyCheckCollision,g=t.maxMouseOutForce,F=t.maxMoveV,L=t.beforeDrawGlobule,P=t.afterDrawGlobule,V=t.afterCalculateNextFrameGlobule;return new o(this.ctx,this.canvas,i,s,e,h,n,r,a,l,u,c,v,f,d,m,y,x,p,M,b,C,g,this.mousePos,F,L,P,V)},i.prototype.updateGlobuleList=function(t){"[object Array]"===Object.prototype.toString.call(t)&&(this.globuleList=t)},i.prototype.stop=function(){this.animationState===t.inAnimation&&(this.animationState=t.stop),this.frameId&&(cancelAnimationFrame(this.frameId),this.frameId=0)},i.prototype._updateMouseProperty=function(t){if(this.prevMousePos.mouseX=this.mousePos.mouseX,this.prevMousePos.mouseY=this.mousePos.mouseY,"mouseLeave"===t.type)this.mousePos.mouseX=null,this.mousePos.mouseY=null;else{var i=this.canvas.getBoundingClientRect(),s=t.clientX-i.left,o=t.clientY-i.top;this.mousePos.mouseX=s,this.mousePos.mouseY=o}switch(this.mouseInGlobuleList=this._getMouseInGlobuleList(t.type),t.type){case"mousedown":this.isMouseDown=!0,this.mouseDownPos.mouseX=this.mousePos.mouseX,this.mouseDownPos.mouseY=this.mousePos.mouseY,this.mouseInGlobuleList.forEach((function(t){t.controlledByMouse=!0}));break;case"mousemove":default:break;case"mouseup":case"mouseleave":this.isMouseDown=!1,this.mouseDownPos.mouseX=null,this.mouseDownPos.mouseY=null}},i.prototype._getMouseInGlobuleList=function(t){var i=[],s=this;return this.globuleList.forEach((function(o){"mousemove"===t&&"drag"===o.mouseInteractionBehavior&&o.controlledByMouse?i.push(o):(o.controlledByMouse=!1,s._checkMouseInGlobule(o)&&i.push(o))})),i},i.prototype._checkMouseInGlobule=function(t){var i=this.mousePos,s=i.mouseX,o=i.mouseY,e=!1;return null!==s&&null!==o&&Math.hypot(s-t.x,o-t.y)<t.radius&&(e=!0),e},i}(),o=function(){function t(t,i,s,o,e,h,n,r,a,l,u,c,v,f,d,m,y,x,p,M,b,C,g,F,L,P,V,w){this.id=s,this.ctx=t,this.canvas=i,this.initX=o||0,this.initY=e||0,this.x=this.initX,this.y=this.initY,this.vx=h||0,this.vy=n||0,this.radius=r||10,this.color=a||"#666666",this.alpha="number"==typeof l?l<0?0:l>1?1:l:1,this.alphaChangeV="number"==typeof u?u:0,this.bgImg=c||"",this.collisionLossV=v||0,this.moveLossV=f||0,this.gDirection=d,this.gCoefficient=m||0,this.requiredMouseInteraction=!!y,this.mouseInteractionBehavior=x||(this.requiredMouseInteraction?"over":void 0),this.fixedPos=!!p,this.receiveOutForce="boolean"!=typeof M||M,this.receiveWallForce="boolean"!=typeof b||b,this.onlyCheckCollision=!!C,this.maxMouseOutForce=g||null,this.mousePos=F||{mouseX:null,mouseY:null},this.maxMoveV=L||null,this.controlledByMouse=!1,this.firstHoverX=null,this.firstHoverY=null,this.outForceLastTime=null,this.inCollisionGlobule=!1,this.inCollisionGlobuleList=[],this.inCollisionWall=!1,this.beforeDrawGlobule=P||null,this.afterDrawGlobule=V||null,this.afterCalculateNextFrameGlobule=w||null}return t.prototype._draw=function(){if(this.ctx.save(),this.ctx.beginPath(),this.bgImg)this.ctx.fillStyle="transparent";else{var t=this.ctx.createRadialGradient(this.x,this.y,0,this.x,this.y,this.radius);t.addColorStop(0,"#ffffff"),t.addColorStop(1,this.color),this.ctx.fillStyle=t}if(this.ctx.globalAlpha=this.alpha,this.ctx.arc(this.x,this.y,this.radius,0,2*Math.PI,!1),this.ctx.fill(),this.bgImg){var i=new Image;i.width=2*this.radius,i.height=2*this.radius,i.src=this.bgImg,this.ctx.drawImage(i,this.x-this.radius,this.y-this.radius,2*this.radius,2*this.radius)}this.ctx.restore()},t.prototype._drawCurrentFrame=function(t,i,s,o,e,h){if(this.receiveOutForce)for(var n=i+1,r=t.length;n<r;n++){var a=t[n];this._checkOverlap(a)}this._checkOverWall(s,o,e,h),this.beforeDrawGlobule&&this.beforeDrawGlobule(this),this._draw(),this.afterDrawGlobule&&this.afterDrawGlobule(this)},t.prototype._calculateNextFrame=function(t,i,s,o,e,h){this._checkHover();for(var n=i+1,r=t.length;n<r;n++){var a=t[n];this._checkCollisionGlobule(a)}if(this._checkCollisionWall(s,o,e,h),this._addGravitation(),this.controlledByMouse||(this.x+=this.vx,this.y+=this.vy),0!==this.alphaChangeV){var l=this.alpha+this.alphaChangeV;l<0?l=0:l>1&&(l=1),this.alpha=l}this._addMoveLoss(),this.afterCalculateNextFrameGlobule&&this.afterCalculateNextFrameGlobule(this)},t.prototype._getOutForce=function(t,i,s,o,e){void 0===e&&(e=!1);var h=this,n=h.x,r=h.y,a=h.vx,l=h.vy,u=0,c=0,v=Math.hypot(t-n,i-r);if(0!==v&&(u=Math.abs(n-t)/v*s,c=Math.abs(r-i)/v*o),s>0?a>0?u-=a:e||(0===this.collisionLossV?u=2*-this.vx:u-=a):s<0?a<=0?u-=a:e||(0===this.collisionLossV?u=2*-this.vx:u-=a):u=2*-this.vx,o>0?l>=0?c-=l:e||(0===this.collisionLossV?c=2*-this.vy:c-=l):o<0?l<=0?c-=l:e||(0===this.collisionLossV?c=2*-this.vy:c-=l):c=2*-this.vy,e){var f=this,d=f.requiredMouseInteraction,m=f.mouseInteractionBehavior,y=f.maxMouseOutForce;d&&"over"===m&&y&&(u>y?u=y:u<-y&&(u=-y),c>y?c=y:c<-y&&(c=-y))}return{outForceVX:u,outForceVY:c}},t.prototype.addOutForce=function(t,i,s){void 0===s&&(s=!1),this.receiveOutForce&&!this.fixedPos&&(this.vx+=t,this.vy+=i,"number"==typeof this.maxMoveV&&this.maxMoveV>=0&&(this.vx>this.maxMoveV?this.vx=this.maxMoveV:this.vx<-this.maxMoveV&&(this.vx=-this.maxMoveV),this.vy>this.maxMoveV?this.vy=this.maxMoveV:this.vy<-this.maxMoveV&&(this.vy=-this.maxMoveV)),s&&(0!==t&&this._addCollisionLoss("x"),0!==i&&this._addCollisionLoss("y")))},t.prototype._checkHover=function(){if(!this.fixedPos&&this.requiredMouseInteraction&&"over"===this.mouseInteractionBehavior){var t=this.mousePos,i=t.mouseX,s=t.mouseY;if(null!==i&&null!==s&&Math.hypot(i-this.x,s-this.y)<=this.radius){if(this.outForceLastTime&&(new Date).getTime()-this.outForceLastTime<400)return;if(null!==this.firstHoverX&&null!==this.firstHoverY){var o=i-this.firstHoverX,e=s-this.firstHoverY,h=this._getOutForce(this.firstHoverX,this.firstHoverY,o,e,!0),n=h.outForceVX,r=h.outForceVY;this.addOutForce(n,r),this.outForceLastTime=(new Date).getTime(),this.firstHoverX=null,this.firstHoverY=null}else this.firstHoverX=i,this.firstHoverY=s}}},t.prototype._checkCollisionWall=function(t,i,s,o){if(this.receiveWallForce&&!this.fixedPos){var e=this,h=e.x,n=e.y,r=e.radius,a=e.vx,l=e.vy,u=0,c=0,v=!1;(h<=r+t||h>=t+s-r)&&0!==a&&(u=2*-a,v=!0),(n<=r+i||n>=i+o-r)&&0!==l&&(c=2*-l,v=!0),v?(this.inCollisionWall=!0,this.addOutForce(u,c,!0)):this.inCollisionWall=!1}},t.prototype._checkCollisionGlobule=function(t){var i=t.x,s=t.y,o=t.radius,e=t.vx,h=t.vy,n=t.receiveOutForce,r=t.onlyCheckCollision,a=t.fixedPos,l=t.controlledByMouse;if((this.receiveOutForce||this.onlyCheckCollision||n||r)&&Math.hypot(i-this.x,s-this.y)<=o+this.radius){var u=this.x+(i-this.x)*(this.radius/(this.radius+o)),c=this.y+(s-this.y)*(this.radius/(this.radius+o)),v=!1;if(e!==this.vx&&(v=!0),h!==this.vy&&(v=!0),v){var f=this.vx,d=this.vy;if(this.receiveOutForce&&n&&!this.fixedPos&&!this.controlledByMouse){var m=this._getOutForce(u,c,e,h),y=m.outForceVX,x=m.outForceVY;this.addOutForce(y,x,!0)}if((this.receiveOutForce||this.onlyCheckCollision)&&(this.inCollisionGlobule=!0,this.inCollisionGlobuleList.push(t)),n&&this.receiveOutForce&&!a&&!l){var p=t._getOutForce(u,c,f,d),M=p.outForceVX,b=p.outForceVY;t.addOutForce(M,b,!0)}(n||r)&&(t.inCollisionGlobule=!0,t.inCollisionGlobuleList.push(this))}}},t.prototype._addCollisionLoss=function(t){if(this.receiveOutForce&&!this.fixedPos&&0!==this.collisionLossV&&!this.controlledByMouse){var i=this.vx,s=this.vy;"x"===t?i>0?Math.abs(i)>this.collisionLossV?this.vx=i-this.collisionLossV:this.vx=0:i<0&&(Math.abs(i)>this.collisionLossV?this.vx=i+this.collisionLossV:this.vx=0):"y"===t&&(s>0?Math.abs(s)>this.collisionLossV?this.vy=s-this.collisionLossV:this.vy=0:s<0&&(Math.abs(s)>this.collisionLossV?this.vy=s+this.collisionLossV:this.vy=0))}},t.prototype._addMoveLoss=function(){this.fixedPos||0===this.moveLossV||this.controlledByMouse||(Math.abs(this.vx)<this.moveLossV?this.vx=0:this.vx>0?this.vx-=this.moveLossV:this.vx+=this.moveLossV,Math.abs(this.vy)<this.moveLossV?this.vy=0:this.vy>0?this.vy-=this.moveLossV:this.vy+=this.moveLossV)},t.prototype._checkOverlap=function(t){var i=t.x,s=t.y,o=t.radius,e=t.receiveOutForce,h=t.fixedPos,n=t.controlledByMouse;if(this.receiveOutForce&&e&&(!this.fixedPos||!h)){var r=Math.hypot(i-this.x,s-this.y);if(r+.2<o+this.radius){var a=o+this.radius-r;this.fixedPos||this.controlledByMouse||h||n||(a/=2);var l=0,u=0;this.x===i?(u=a,this.y>s?(this.fixedPos||this.controlledByMouse||(this.y=this.y+u),h||n||(t.y=s-u)):(this.fixedPos||this.controlledByMouse||(this.y=this.y-a),h||n||(t.y=s+a))):this.y===s?(l=a,this.x>i?(this.fixedPos||this.controlledByMouse||(this.x=this.x+l),h||n||(t.x=i-l)):(this.fixedPos||this.controlledByMouse||(this.x=this.x-l),h||n||(t.x=i+l))):this.x>i?(l=a/r*Math.abs(this.x-i),u=a/r*Math.abs(this.y-s),this.y>s?(this.fixedPos||this.controlledByMouse||(this.x=this.x+l,this.y=this.y+u),h||n||(t.x=i-l,t.y=s-u)):(this.fixedPos||this.controlledByMouse||(this.x=this.x+l,this.y=this.y-u),h||n||(t.x=i-l,t.y=s+u))):(l=a/r*Math.abs(this.x-i),u=a/r*Math.abs(this.y-s),this.y>s?(this.fixedPos||this.controlledByMouse||(this.x=this.x-l,this.y=this.y+u),h||n||(t.x=i+l,t.y=s-u)):(this.fixedPos||this.controlledByMouse||(this.x=this.x-l,this.y=this.y-u),h||n||(t.x=i+l,t.y=s+u)))}}},t.prototype._checkOverWall=function(t,i,s,o){if(this.receiveWallForce&&!this.fixedPos){var e=this,h=e.x,n=e.y,r=e.radius;h<r+t?this.x=r+t:this.x>t+s-r&&(this.x=t+s-r),n<r+i?this.y=r+i:n>i+o-r&&(this.y=i+o-r)}},t.prototype._addGravitation=function(){if(this.receiveOutForce&&!this.fixedPos&&this.gDirection&&this.gCoefficient&&!this.controlledByMouse)switch(this.gDirection){case"toInit":var t=(this.initX-this.x)*this.gCoefficient,i=(this.initY-this.y)*this.gCoefficient;this.addOutForce(t,i);break;case"toBottom":var s=this.gCoefficient;this.addOutForce(0,s);break;case"toTop":var o=-this.gCoefficient;this.addOutForce(0,o);break;case"toLeft":var e=-this.gCoefficient;this.addOutForce(e,0);break;case"toRight":var h=this.gCoefficient;this.addOutForce(h,0)}},t}();return i.default=s,i.default}()}));