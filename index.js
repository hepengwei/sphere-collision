!function(t,i){"object"==typeof exports&&"object"==typeof module?module.exports=i():"function"==typeof define&&define.amd?define([],i):"object"==typeof exports?exports.SphereCollision=i():t.SphereCollision=i()}(self,(function(){return function(){"use strict";var t,i={};!function(t){t[t.waitStart=0]="waitStart",t[t.inAnimation=1]="inAnimation",t[t.stop=2]="stop"}(t||(t={}));var s=function(){function i(i,s,e,h){this.ctx=i||null,this.canvas=s||null,this.options={collisionRectX:0,collisionRectY:0,collisionRectWidth:s.width,collisionRectHeight:s.height,monitorMousePos:!1,beforeDrawGlobules:null,afterDrawGlobules:null,onMouseDownCanvas:null,onMouseMoveCanvas:null,onMouseUpCanvas:null,onMouseLeaveCanvas:null},h&&(this.options=Object.assign({},this.options,h)),this.frameId=0,this.animationState=t.waitStart,this.mousePos={mouseX:null,mouseY:null},this.prevMousePos={mouseX:null,mouseY:null},this.isMouseDown=!1,this.mouseDownPos={mouseX:null,mouseY:null};var n=[];if(e&&e.length>0)for(var r=0,l=e.length;r<l;r++){var a=e[r],u=a.id,c=a.initX,v=a.initY,f=a.vx,d=a.vy,m=a.radius,y=a.color,x=a.isPureColor,p=a.alpha,M=a.alphaChangeV,b=a.bgImg,C=a.collisionLossV,g=a.moveLossV,P=a.gDirection,F=a.gCoefficient,L=a.requiredMouseInteraction,V=a.mouseInteractionBehavior,w=a.fixedPos,G=a.receiveOutForce,D=a.receiveWallForce,I=a.resistanceWallDirection,O=a.onlyCheckCollision,_=a.maxMouseOutForce,X=a.maxMoveV,Y=a.beforeDrawGlobule,B=a.afterDrawGlobule,k=a.afterCalculateNextFrameGlobule,W=new o(i,s,u,c,v,f,d,m,y,x,p,M,b,C,g,P,F,L,V,w,G,D,I,O,_,this.mousePos,X,Y,B,k);n.push(W)}if(this.globuleList=n,this.options.monitorMousePos){var H=this;s.addEventListener("mousedown",(function(t){H._updateMouseProperty(t),H.mouseInGlobuleList.forEach((function(t){var i=t.requiredMouseInteraction,s=t.mouseInteractionBehavior;i&&"drag"===s&&(t.vx=0,t.vy=0)})),H.options.onMouseDownCanvas&&H.options.onMouseDownCanvas(t,H)})),s.addEventListener("mousemove",(function(t){H._updateMouseProperty(t),H.isMouseDown&&H.mouseInGlobuleList.forEach((function(t){var i=t.requiredMouseInteraction,s=t.mouseInteractionBehavior;if(i&&"drag"===s){var o=H.mousePos.mouseX-H.prevMousePos.mouseX,e=H.mousePos.mouseY-H.prevMousePos.mouseY;t.x+=o,t.y+=e;var h=t.receiveOutForce,n=t.maxMouseOutForce;if(h){var r=o,l=e;n&&(r>n?r=n:r<-n&&(r=-n),l>n?l=n:l<-n&&(l=-n)),t.vx=r,t.vy=l}}})),H.options.onMouseMoveCanvas&&H.options.onMouseMoveCanvas(t,H)})),s.addEventListener("mouseup",(function(t){H._updateMouseProperty(t),H.options.onMouseUpCanvas&&H.options.onMouseUpCanvas(t,H)})),s.addEventListener("mouseleave",(function(t){H._updateMouseProperty(t),H.options.onMouseLeaveCanvas&&H.options.onMouseLeaveCanvas(t,H)}))}}return i.prototype.start=function(){var i=this;this.animationState=t.inAnimation,i.frameId=requestAnimationFrame((function s(){if(i.animationState===t.inAnimation){var o=i.ctx,e=i.canvas,h=i.globuleList,n=i.options,r=n.beforeDrawGlobules,l=n.afterDrawGlobules,a=n.collisionRectX,u=n.collisionRectY,c=n.collisionRectWidth,v=n.collisionRectHeight,f=e.width,d=e.height;r?r&&r(i):o.clearRect(0,0,f,d),h.forEach((function(t,i){t._drawCurrentFrame(h,i,a,u,c,v)})),l&&l(i),h.forEach((function(t){t.inCollisionGlobule=!1,t.inCollisionGlobuleList=[],t.inCollisionWall=!1})),h.forEach((function(t,i){t._calculateNextFrame(h,i,a,u,c,v)})),i.frameId=requestAnimationFrame(s)}}))},i.prototype.createGlobule=function(t){var i=t.id,s=t.initX,e=t.initY,h=t.vx,n=t.vy,r=t.radius,l=t.color,a=t.isPureColor,u=t.alpha,c=t.alphaChangeV,v=t.bgImg,f=t.collisionLossV,d=t.moveLossV,m=t.gDirection,y=t.gCoefficient,x=t.requiredMouseInteraction,p=t.mouseInteractionBehavior,M=t.fixedPos,b=t.receiveOutForce,C=t.receiveWallForce,g=t.resistanceWallDirection,P=t.onlyCheckCollision,F=t.maxMouseOutForce,L=t.maxMoveV,V=t.beforeDrawGlobule,w=t.afterDrawGlobule,G=t.afterCalculateNextFrameGlobule;return new o(this.ctx,this.canvas,i,s,e,h,n,r,l,a,u,c,v,f,d,m,y,x,p,M,b,C,g,P,F,this.mousePos,L,V,w,G)},i.prototype.updateGlobuleList=function(t){"[object Array]"===Object.prototype.toString.call(t)&&(this.globuleList=t)},i.prototype.stop=function(){this.animationState===t.inAnimation&&(this.animationState=t.stop),this.frameId&&(cancelAnimationFrame(this.frameId),this.frameId=0)},i.prototype._updateMouseProperty=function(t){if(this.prevMousePos.mouseX=this.mousePos.mouseX,this.prevMousePos.mouseY=this.mousePos.mouseY,"mouseLeave"===t.type)this.mousePos.mouseX=null,this.mousePos.mouseY=null;else{var i=this.canvas.getBoundingClientRect(),s=t.clientX-i.left,o=t.clientY-i.top;this.mousePos.mouseX=s,this.mousePos.mouseY=o}switch(this.mouseInGlobuleList=this._getMouseInGlobuleList(t.type),t.type){case"mousedown":this.isMouseDown=!0,this.mouseDownPos.mouseX=this.mousePos.mouseX,this.mouseDownPos.mouseY=this.mousePos.mouseY,this.mouseInGlobuleList.forEach((function(t){t.controlledByMouse=!0}));break;case"mousemove":default:break;case"mouseup":case"mouseleave":this.isMouseDown=!1,this.mouseDownPos.mouseX=null,this.mouseDownPos.mouseY=null}},i.prototype._getMouseInGlobuleList=function(t){var i=[],s=this;return this.globuleList.forEach((function(o){"mousemove"===t&&"drag"===o.mouseInteractionBehavior&&o.controlledByMouse?i.push(o):(o.controlledByMouse=!1,s._checkMouseInGlobule(o)&&i.push(o))})),i},i.prototype._checkMouseInGlobule=function(t){var i=this.mousePos,s=i.mouseX,o=i.mouseY,e=!1;return null!==s&&null!==o&&Math.hypot(s-t.x,o-t.y)<t.radius&&(e=!0),e},i}(),o=function(){function t(t,i,s,o,e,h,n,r,l,a,u,c,v,f,d,m,y,x,p,M,b,C,g,P,F,L,V,w,G,D){this.id=s,this.ctx=t,this.canvas=i,this.initX=o||0,this.initY=e||0,this.x=this.initX,this.y=this.initY,this.vx=h||0,this.vy=n||0,this.radius=r||10,this.color=l||"#666666",this.isPureColor=!!a,this.alpha="number"==typeof u?u<0?0:u>1?1:u:1,this.alphaChangeV="number"==typeof c?c:0,this.bgImg=v||"",this.collisionLossV=f||0,this.moveLossV=d||0,this.gDirection=m,this.gCoefficient=y||0,this.requiredMouseInteraction=!!x,this.mouseInteractionBehavior=p||(this.requiredMouseInteraction?"over":void 0),this.fixedPos=!!M,this.receiveOutForce="boolean"!=typeof b||b,this.receiveWallForce="boolean"!=typeof C||C,this.resistanceWallDirection=g&&g.length>1?g:["bottom","top","left","right"],this.onlyCheckCollision=!!P,this.maxMouseOutForce=F||null,this.mousePos=L||{mouseX:null,mouseY:null},this.maxMoveV=V||null,this.controlledByMouse=!1,this.firstHoverX=null,this.firstHoverY=null,this.outForceLastTime=null,this.inCollisionGlobule=!1,this.inCollisionGlobuleList=[],this.inCollisionWall=!1,this.beforeDrawGlobule=w||null,this.afterDrawGlobule=G||null,this.afterCalculateNextFrameGlobule=D||null}return t.prototype._draw=function(){if(this.ctx.save(),this.ctx.beginPath(),this.color)if(this.isPureColor)this.ctx.fillStyle=this.color;else{var t=this.ctx.createRadialGradient(this.x,this.y,0,this.x,this.y,this.radius);t.addColorStop(0,"#ffffff"),t.addColorStop(1,this.color),this.ctx.fillStyle=t}if(this.ctx.globalAlpha=this.alpha,this.ctx.arc(this.x,this.y,this.radius,0,2*Math.PI,!1),this.ctx.fill(),this.bgImg){var i=new Image;i.width=2*this.radius,i.height=2*this.radius,i.src=this.bgImg,this.ctx.drawImage(i,this.x-this.radius,this.y-this.radius,2*this.radius,2*this.radius)}this.ctx.restore()},t.prototype._drawCurrentFrame=function(t,i,s,o,e,h){if(this.receiveOutForce)for(var n=i+1,r=t.length;n<r;n++){var l=t[n];this._checkOverlap(l)}this._checkOverWall(s,o,e,h),this.beforeDrawGlobule&&this.beforeDrawGlobule(this),this._draw(),this.afterDrawGlobule&&this.afterDrawGlobule(this)},t.prototype._calculateNextFrame=function(t,i,s,o,e,h){this._checkHover();for(var n=i+1,r=t.length;n<r;n++){var l=t[n];this._checkCollisionGlobule(l)}if(this._checkCollisionWall(s,o,e,h),this._addGravitation(),this.controlledByMouse||(this.x+=this.vx,this.y+=this.vy),0!==this.alphaChangeV){var a=this.alpha+this.alphaChangeV;a<0?a=0:a>1&&(a=1),this.alpha=a}this._addMoveLoss(),this.afterCalculateNextFrameGlobule&&this.afterCalculateNextFrameGlobule(this)},t.prototype._getOutForce=function(t,i,s,o,e){void 0===e&&(e=!1);var h=this,n=h.x,r=h.y,l=h.vx,a=h.vy,u=0,c=0,v=Math.hypot(t-n,i-r);if(0!==v&&(u=Math.abs(n-t)/v*s,c=Math.abs(r-i)/v*o),s>0?l>0?u-=l:e||(0===this.collisionLossV?u=2*-this.vx:u-=l):s<0?l<=0?u-=l:e||(0===this.collisionLossV?u=2*-this.vx:u-=l):u=2*-this.vx,o>0?a>=0?c-=a:e||(0===this.collisionLossV?c=2*-this.vy:c-=a):o<0?a<=0?c-=a:e||(0===this.collisionLossV?c=2*-this.vy:c-=a):c=2*-this.vy,e){var f=this,d=f.requiredMouseInteraction,m=f.mouseInteractionBehavior,y=f.maxMouseOutForce;d&&"over"===m&&y&&(u>y?u=y:u<-y&&(u=-y),c>y?c=y:c<-y&&(c=-y))}return{outForceVX:u,outForceVY:c}},t.prototype.addOutForce=function(t,i,s){void 0===s&&(s=!1),this.fixedPos||(this.vx+=t,this.vy+=i,"number"==typeof this.maxMoveV&&this.maxMoveV>=0&&(this.vx>this.maxMoveV?this.vx=this.maxMoveV:this.vx<-this.maxMoveV&&(this.vx=-this.maxMoveV),this.vy>this.maxMoveV?this.vy=this.maxMoveV:this.vy<-this.maxMoveV&&(this.vy=-this.maxMoveV)),s&&(0!==t&&this._addCollisionLoss("x"),0!==i&&this._addCollisionLoss("y")))},t.prototype._checkHover=function(){if(!this.fixedPos&&this.requiredMouseInteraction&&"over"===this.mouseInteractionBehavior){var t=this.mousePos,i=t.mouseX,s=t.mouseY;if(null!==i&&null!==s&&Math.hypot(i-this.x,s-this.y)<=this.radius){if(this.outForceLastTime&&(new Date).getTime()-this.outForceLastTime<400)return;if(null!==this.firstHoverX&&null!==this.firstHoverY){var o=i-this.firstHoverX,e=s-this.firstHoverY,h=this._getOutForce(this.firstHoverX,this.firstHoverY,o,e,!0),n=h.outForceVX,r=h.outForceVY;this.addOutForce(n,r),this.outForceLastTime=(new Date).getTime(),this.firstHoverX=null,this.firstHoverY=null}else this.firstHoverX=i,this.firstHoverY=s}}},t.prototype._checkCollisionWall=function(t,i,s,o){if(this.receiveWallForce&&!this.fixedPos){var e=this,h=e.x,n=e.y,r=e.radius,l=e.vx,a=e.vy,u=e.resistanceWallDirection,c=0,v=0,f=!1;u.includes("bottom")&&n>=i+o-r&&0!==a&&(v=2*-a,f=!0),u.includes("top")&&n<=r+i&&0!==a&&(v=2*-a,f=!0),u.includes("left")&&h<=r+t&&0!==l&&(c=2*-l,f=!0),u.includes("right")&&h>=t+s-r&&0!==l&&(c=2*-l,f=!0),f?(this.inCollisionWall=!0,this.addOutForce(c,v,!0)):this.inCollisionWall=!1}},t.prototype._checkCollisionGlobule=function(t){var i=t.x,s=t.y,o=t.radius,e=t.vx,h=t.vy,n=t.receiveOutForce,r=t.onlyCheckCollision,l=t.fixedPos,a=t.controlledByMouse;if((this.receiveOutForce||this.onlyCheckCollision||n||r)&&Math.hypot(i-this.x,s-this.y)<=o+this.radius){var u=this.x+(i-this.x)*(this.radius/(this.radius+o)),c=this.y+(s-this.y)*(this.radius/(this.radius+o)),v=!1;if(e!==this.vx&&(v=!0),h!==this.vy&&(v=!0),v){var f=this.vx,d=this.vy;if(this.receiveOutForce&&n&&!this.fixedPos&&!this.controlledByMouse){var m=this._getOutForce(u,c,e,h),y=m.outForceVX,x=m.outForceVY;this.addOutForce(y,x,!0)}if((this.receiveOutForce||this.onlyCheckCollision)&&(this.inCollisionGlobule=!0,this.inCollisionGlobuleList.push(t)),n&&this.receiveOutForce&&!l&&!a){var p=t._getOutForce(u,c,f,d),M=p.outForceVX,b=p.outForceVY;t.addOutForce(M,b,!0)}(n||r)&&(t.inCollisionGlobule=!0,t.inCollisionGlobuleList.push(this))}}},t.prototype._addCollisionLoss=function(t){if(this.receiveOutForce&&!this.fixedPos&&0!==this.collisionLossV&&!this.controlledByMouse){var i=this.vx,s=this.vy;"x"===t?i>0?Math.abs(i)>this.collisionLossV?this.vx=i-this.collisionLossV:this.vx=0:i<0&&(Math.abs(i)>this.collisionLossV?this.vx=i+this.collisionLossV:this.vx=0):"y"===t&&(s>0?Math.abs(s)>this.collisionLossV?this.vy=s-this.collisionLossV:this.vy=0:s<0&&(Math.abs(s)>this.collisionLossV?this.vy=s+this.collisionLossV:this.vy=0))}},t.prototype._addMoveLoss=function(){this.fixedPos||0===this.moveLossV||this.controlledByMouse||(Math.abs(this.vx)<this.moveLossV?this.vx=0:this.vx>0?this.vx-=this.moveLossV:this.vx+=this.moveLossV,Math.abs(this.vy)<this.moveLossV?this.vy=0:this.vy>0?this.vy-=this.moveLossV:this.vy+=this.moveLossV)},t.prototype._checkOverlap=function(t){var i=t.x,s=t.y,o=t.radius,e=t.receiveOutForce,h=t.fixedPos,n=t.controlledByMouse;if(this.receiveOutForce&&e&&(!this.fixedPos||!h)){var r=Math.hypot(i-this.x,s-this.y);if(r+.2<o+this.radius){var l=o+this.radius-r;this.fixedPos||this.controlledByMouse||h||n||(l/=2);var a=0,u=0;this.x===i?(u=l,this.y>s?(this.fixedPos||this.controlledByMouse||(this.y=this.y+u),h||n||(t.y=s-u)):(this.fixedPos||this.controlledByMouse||(this.y=this.y-l),h||n||(t.y=s+l))):this.y===s?(a=l,this.x>i?(this.fixedPos||this.controlledByMouse||(this.x=this.x+a),h||n||(t.x=i-a)):(this.fixedPos||this.controlledByMouse||(this.x=this.x-a),h||n||(t.x=i+a))):this.x>i?(a=l/r*Math.abs(this.x-i),u=l/r*Math.abs(this.y-s),this.y>s?(this.fixedPos||this.controlledByMouse||(this.x=this.x+a,this.y=this.y+u),h||n||(t.x=i-a,t.y=s-u)):(this.fixedPos||this.controlledByMouse||(this.x=this.x+a,this.y=this.y-u),h||n||(t.x=i-a,t.y=s+u))):(a=l/r*Math.abs(this.x-i),u=l/r*Math.abs(this.y-s),this.y>s?(this.fixedPos||this.controlledByMouse||(this.x=this.x-a,this.y=this.y+u),h||n||(t.x=i+a,t.y=s-u)):(this.fixedPos||this.controlledByMouse||(this.x=this.x-a,this.y=this.y-u),h||n||(t.x=i+a,t.y=s+u)))}}},t.prototype._checkOverWall=function(t,i,s,o){if(this.receiveWallForce&&!this.fixedPos){var e=this,h=e.x,n=e.y,r=e.radius;this.resistanceWallDirection.includes("bottom")&&n>i+o-r&&(this.y=i+o-r),this.resistanceWallDirection.includes("top")&&n<r+i&&(this.y=r+i),this.resistanceWallDirection.includes("left")&&h<r+t&&(this.x=r+t),this.resistanceWallDirection.includes("right")&&this.x>t+s-r&&(this.x=t+s-r)}},t.prototype._addGravitation=function(){if(!this.fixedPos&&this.gDirection&&this.gCoefficient&&!this.controlledByMouse)switch(this.gDirection){case"toInit":var t=(this.initX-this.x)*this.gCoefficient,i=(this.initY-this.y)*this.gCoefficient;this.addOutForce(t,i);break;case"toBottom":var s=this.gCoefficient;this.addOutForce(0,s);break;case"toTop":var o=-this.gCoefficient;this.addOutForce(0,o);break;case"toLeft":var e=-this.gCoefficient;this.addOutForce(e,0);break;case"toRight":var h=this.gCoefficient;this.addOutForce(h,0)}},t}();return i.default=s,i.default}()}));