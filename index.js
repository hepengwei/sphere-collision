!function(t,i){"object"==typeof exports&&"object"==typeof module?module.exports=i():"function"==typeof define&&define.amd?define([],i):"object"==typeof exports?exports.SphereCollision=i():t.SphereCollision=i()}(self,(function(){return function(){"use strict";var t,i={};!function(t){t[t.waitStart=0]="waitStart",t[t.inAnimation=1]="inAnimation",t[t.stop=2]="stop"}(t||(t={}));var o=function(){function i(i,o,s,h){this.ctx=i||null,this.canvas=o||null,this.options={collisionRectX:0,collisionRectY:0,collisionRectWidth:o.width,collisionRectHeight:o.height,monitorMousePos:!1,beforeDrawGlobules:null,afterDrawGlobules:null,onMouseDownCanvas:null,onMouseMoveCanvas:null,onMouseUpCanvas:null,onMouseLeaveCanvas:null},h&&(this.options=Object.assign({},this.options,h)),this.frameId=0,this.animationState=t.waitStart,this.mousePos={mouseX:null,mouseY:null},this.prevMousePos={mouseX:null,mouseY:null},this.isMouseDown=!1,this.mouseDownPos={mouseX:null,mouseY:null};var r=[];if(s&&s.length>0)for(var n=0,l=s.length;n<l;n++){var a=s[n],u=a.id,c=a.initX,v=a.initY,f=a.vx,d=a.vy,y=a.radius,p=a.color,m=a.isPureColor,x=a.alpha,M=a.alphaChangeV,b=a.bgImg,g=a.collisionLossV,C=a.moveLossV,F=a.gDirection,P=a.gCoefficient,w=a.requiredMouseInteraction,L=a.mouseInteractionBehavior,G=a.fixedPos,X=a.receiveOutForce,Y=a.receiveWallForce,_=a.resistanceWallDirection,D=a.onlyCheckCollision,I=a.maxMouseOutForce,O=a.maxMoveV,V=a.beforeDrawGlobule,B=a.afterDrawGlobule,k=a.afterCalculateNextFrameGlobule,W=new e(i,o,u,c,v,f,d,y,p,m,x,M,b,g,C,F,P,w,L,G,X,Y,_,D,I,this.mousePos,O,V,B,k);r.push(W)}if(this.globuleList=r,this.options.monitorMousePos){var A=this;o.addEventListener("mousedown",(function(t){A._updateMouseProperty(t),A.mouseInGlobuleList.forEach((function(t){var i=t.requiredMouseInteraction,o=t.mouseInteractionBehavior;i&&"drag"===o&&(t.vx=0,t.vy=0)})),A.options.onMouseDownCanvas&&A.options.onMouseDownCanvas(t,A)})),o.addEventListener("mousemove",(function(t){A._updateMouseProperty(t),A.isMouseDown&&A.mouseInGlobuleList.forEach((function(t){var i=t.requiredMouseInteraction,o=t.mouseInteractionBehavior;if(i&&"drag"===o){var e=A.mousePos.mouseX-A.prevMousePos.mouseX,s=A.mousePos.mouseY-A.prevMousePos.mouseY;t.x+=e,t.y+=s;var h=t.receiveOutForce,r=t.maxMouseOutForce;if(h){var n=e,l=s;if(r){var a=t.getXAndYValue(r,e,s),u=a.x,c=a.y;n>u?n=u:n<-u&&(n=-u),l>c?l=c:l<-c&&(l=-c)}t.vx=n,t.vy=l}}})),A.options.onMouseMoveCanvas&&A.options.onMouseMoveCanvas(t,A)})),o.addEventListener("mouseup",(function(t){A._updateMouseProperty(t),A.options.onMouseUpCanvas&&A.options.onMouseUpCanvas(t,A)})),o.addEventListener("mouseleave",(function(t){A._updateMouseProperty(t),A.options.onMouseLeaveCanvas&&A.options.onMouseLeaveCanvas(t,A)}))}}return i.prototype.start=function(){var i=this;this.animationState=t.inAnimation,i.frameId=requestAnimationFrame((function o(){if(i.animationState===t.inAnimation){var e=i.ctx,s=i.canvas,h=i.globuleList,r=i.options,n=r.beforeDrawGlobules,l=r.afterDrawGlobules,a=r.collisionRectX,u=r.collisionRectY,c=r.collisionRectWidth,v=r.collisionRectHeight,f=s.width,d=s.height;n?n&&n(i):e.clearRect(0,0,f,d),h.forEach((function(t,i){t._drawCurrentFrame(h,i,a,u,c,v)})),l&&l(i),h.forEach((function(t){t.inCollisionGlobule=!1,t.inCollisionGlobuleList=[],t.inCollisionWall=!1})),h.forEach((function(t,i){t._calculateNextFrame(h,i,a,u,c,v)})),i.frameId=requestAnimationFrame(o)}}))},i.prototype.createGlobule=function(t){var i=t.id,o=t.initX,s=t.initY,h=t.vx,r=t.vy,n=t.radius,l=t.color,a=t.isPureColor,u=t.alpha,c=t.alphaChangeV,v=t.bgImg,f=t.collisionLossV,d=t.moveLossV,y=t.gDirection,p=t.gCoefficient,m=t.requiredMouseInteraction,x=t.mouseInteractionBehavior,M=t.fixedPos,b=t.receiveOutForce,g=t.receiveWallForce,C=t.resistanceWallDirection,F=t.onlyCheckCollision,P=t.maxMouseOutForce,w=t.maxMoveV,L=t.beforeDrawGlobule,G=t.afterDrawGlobule,X=t.afterCalculateNextFrameGlobule;return new e(this.ctx,this.canvas,i,o,s,h,r,n,l,a,u,c,v,f,d,y,p,m,x,M,b,g,C,F,P,this.mousePos,w,L,G,X)},i.prototype.updateGlobuleList=function(t){"[object Array]"===Object.prototype.toString.call(t)&&(this.globuleList=t)},i.prototype.stop=function(){this.animationState===t.inAnimation&&(this.animationState=t.stop),this.frameId&&(cancelAnimationFrame(this.frameId),this.frameId=0)},i.prototype._updateMouseProperty=function(t){if(this.prevMousePos.mouseX=this.mousePos.mouseX,this.prevMousePos.mouseY=this.mousePos.mouseY,"mouseLeave"===t.type)this.mousePos.mouseX=null,this.mousePos.mouseY=null;else{var i=this.canvas.getBoundingClientRect(),o=t.clientX-i.left,e=t.clientY-i.top;this.mousePos.mouseX=o,this.mousePos.mouseY=e}switch(this.mouseInGlobuleList=this._getMouseInGlobuleList(t.type),t.type){case"mousedown":this.isMouseDown=!0,this.mouseDownPos.mouseX=this.mousePos.mouseX,this.mouseDownPos.mouseY=this.mousePos.mouseY,this.mouseInGlobuleList.forEach((function(t){t.controlledByMouse=!0}));break;case"mousemove":default:break;case"mouseup":case"mouseleave":this.isMouseDown=!1,this.mouseDownPos.mouseX=null,this.mouseDownPos.mouseY=null}},i.prototype._getMouseInGlobuleList=function(t){var i=[],o=this;return this.globuleList.forEach((function(e){"mousemove"===t&&"drag"===e.mouseInteractionBehavior&&e.controlledByMouse?i.push(e):(e.controlledByMouse=!1,o._checkMouseInGlobule(e)&&i.push(e))})),i},i.prototype._checkMouseInGlobule=function(t){var i=this.mousePos,o=i.mouseX,e=i.mouseY,s=!1;return null!==o&&null!==e&&Math.hypot(o-t.x,e-t.y)<t.radius&&(s=!0),s},i}(),e=function(){function t(t,i,o,e,s,h,r,n,l,a,u,c,v,f,d,y,p,m,x,M,b,g,C,F,P,w,L,G,X,Y){this.id=o,this.ctx=t,this.canvas=i,this.initX=e||0,this.initY=s||0,this.x=this.initX,this.y=this.initY,this.previousX=null,this.previousY=null,this.vx=h||0,this.vy=r||0,this.radius=n||10,this.color=l||"#666666",this.isPureColor=!!a,this.alpha="number"==typeof u?u<0?0:u>1?1:u:1,this.alphaChangeV="number"==typeof c?c:0,this.bgImg=v||"",this.collisionLossV=f||0,this.moveLossV=d||0,this.gDirection=y,this.gCoefficient=p||0,this.requiredMouseInteraction=!!m,this.mouseInteractionBehavior=x||(this.requiredMouseInteraction?"over":void 0),this.fixedPos=!!M,this.receiveOutForce="boolean"!=typeof b||b,this.receiveWallForce="boolean"!=typeof g||g,this.resistanceWallDirection=C&&C.length>1?C:["bottom","top","left","right"],this.onlyCheckCollision=!!F,this.maxMouseOutForce=P||null,this.mousePos=w||{mouseX:null,mouseY:null},this.maxMoveV=L||null,this.controlledByMouse=!1,this.firstHoverX=null,this.firstHoverY=null,this.outForceLastTime=null,this.inCollisionGlobule=!1,this.inCollisionGlobuleList=[],this.inCollisionWall=!1,this.beforeDrawGlobule=G||null,this.afterDrawGlobule=X||null,this.afterCalculateNextFrameGlobule=Y||null}return t.prototype._draw=function(){if(this.ctx.save(),this.ctx.beginPath(),this.color)if(this.isPureColor)this.ctx.fillStyle=this.color;else{var t=this.ctx.createRadialGradient(this.x,this.y,0,this.x,this.y,this.radius);t.addColorStop(0,"#ffffff"),t.addColorStop(1,this.color),this.ctx.fillStyle=t}if(this.ctx.globalAlpha=this.alpha,this.ctx.arc(this.x,this.y,this.radius,0,2*Math.PI,!1),this.ctx.fill(),this.bgImg){var i=new Image;i.width=2*this.radius,i.height=2*this.radius,i.src=this.bgImg,this.ctx.drawImage(i,this.x-this.radius,this.y-this.radius,2*this.radius,2*this.radius)}this.ctx.restore(),this.previousX=this.x,this.previousY=this.y},t.prototype._drawCurrentFrame=function(t,i,o,e,s,h){if(this.receiveOutForce)for(var r=i+1,n=t.length;r<n;r++){var l=t[r];this._checkOverlap(l)}this._checkOverWall(o,e,s,h),null!==this.previousX&&null!==this.previousY&&this.previousX===this.x&&this.previousY===this.y&&(0!==this.vx&&(this.vx=0),0!==this.vy&&(this.vy=0)),this.beforeDrawGlobule&&this.beforeDrawGlobule(this),this._draw(),this.afterDrawGlobule&&this.afterDrawGlobule(this)},t.prototype._calculateNextFrame=function(t,i,o,e,s,h){this._checkHover();for(var r=i+1,n=t.length;r<n;r++){var l=t[r];this._checkCollisionGlobule(l)}if(this._checkCollisionWall(o,e,s,h),this._addGravitation(),this.controlledByMouse||(this.x+=this.vx,this.y+=this.vy),0!==this.alphaChangeV){var a=this.alpha+this.alphaChangeV;a<0?a=0:a>1&&(a=1),this.alpha=a}this._addMoveLoss(),this.afterCalculateNextFrameGlobule&&this.afterCalculateNextFrameGlobule(this)},t.prototype._getOutForce=function(t,i,o,e){var s=this,h=s.x,r=s.y,n=s.vx,l=s.vy,a=0,u=0;if(h===t)r>i?0===n&&0===l?e>0&&(u=e):0===o&&0===e?l<0&&(u=2*-l):0===n&&0===o?u=-l+e:n>0&&o>0||n<0&&o<0?(l<0&&e>0||(l>0&&e>0||l<0&&e<0)&&l<e)&&(u=-l+e):(n>0&&o<0||n<0&&o>0)&&l<0&&e>0&&(u=-l+e):0===n&&0===l?e<0&&(u=e):0===o&&0===e?l>0&&(u=2*-l):0===n&&0===o?u=-l+e:n>0&&o>0||n<0&&o<0?(l>0&&e<0||(l>0&&e>0||l<0&&e<0)&&l>e)&&(u=-l+e):(n>0&&o<0||n<0&&o>0)&&l>0&&e<0&&(u=-l+e);else if(r==i)h>t?0===n&&0===l?o>0&&(a=o):0===o&&0===e?n<0&&(a=2*-n):0===l&&n<0&&0===e&&o>0?a=-n+o:l>0&&e>0||l<0&&e<0?(n<0&&o>0||(n>0&&o>0||n<0&&o<0)&&n<o)&&(a=-n+o):(l>0&&e<0||l<0&&e>0)&&n<0&&o>0&&(a=-n+o):0===n&&0===l?o<0&&(a=o):0===o&&0===e?n>0&&(a=2*-n):0===l&&n>0&&0===e&&o<0?a=-n+o:l>0&&e>0||l<0&&e<0?(n>0&&o<0||(n>0&&o>0||n<0&&o<0)&&n>o)&&(a=-n+o):(l>0&&e<0||l<0&&e>0)&&n>0&&o<0&&(a=-n+o);else if(0===n&&0===l){var c=this._getCosspoint(t+o,i+e,t,i,h,r);a=c.x-t,u=c.y-i}else if(0===o&&0===e){var v=this._getCosspoint(h+n,r+l,h,r,t,i);a=-(v.x-h),u=-(v.y-r)}else{var f=this._getCosspoint(t+o,i+e,t,i,h,r);((a=f.x-t)>0&&n>0||a<0&&n<0)&&(a-=n),((u=f.y-i)>0&&l>0||u<0&&l<0)&&(u-=l)}return{outForceVX:a,outForceVY:u}},t.prototype._getMouseOutForce=function(t,i){var o=t,e=i,s=this,h=s.requiredMouseInteraction,r=s.mouseInteractionBehavior,n=s.maxMouseOutForce;return h&&"over"===r&&n&&(o>n?o=n:o<-n&&(o=-n),e>n?e=n:e<-n&&(e=-n)),{outForceVX:o,outForceVY:e}},t.prototype.addOutForce=function(t,i,o){if(void 0===o&&(o=!1),!this.fixedPos&&(this.vx+=t,this.vy+=i,o&&this._addCollisionLoss(),"number"==typeof this.maxMoveV&&this.maxMoveV>=0&&Math.hypot(this.vx,this.vy)>this.maxMoveV)){var e=this.getXAndYValue(this.maxMoveV,this.vx,this.vy),s=e.x,h=e.y;this.vx=s,this.vy=h}},t.prototype._checkHover=function(){if(!this.fixedPos&&this.requiredMouseInteraction&&"over"===this.mouseInteractionBehavior){var t=this.mousePos,i=t.mouseX,o=t.mouseY;if(null!==i&&null!==o&&Math.hypot(i-this.x,o-this.y)<=this.radius){if(this.outForceLastTime&&(new Date).getTime()-this.outForceLastTime<400)return;if(null!==this.firstHoverX&&null!==this.firstHoverY){var e=i-this.firstHoverX,s=o-this.firstHoverY,h=this._getMouseOutForce(e,s),r=h.outForceVX,n=h.outForceVY;this.addOutForce(r,n),this.outForceLastTime=(new Date).getTime(),this.firstHoverX=null,this.firstHoverY=null}else this.firstHoverX=i,this.firstHoverY=o}}},t.prototype._checkCollisionWall=function(t,i,o,e){if(this.receiveWallForce&&!this.fixedPos){var s=this,h=s.x,r=s.y,n=s.radius,l=s.vx,a=s.vy,u=s.resistanceWallDirection,c=0,v=0,f=!1;u.includes("bottom")&&r>=i+e-n&&a>0&&(v=2*-a,f=!0),u.includes("top")&&r<=n+i&&a<0&&(v=2*-a,f=!0),u.includes("left")&&h<=n+t&&l<0&&(c=2*-l,f=!0),u.includes("right")&&h>=t+o-n&&l>0&&(c=2*-l,f=!0),f?(this.inCollisionWall=!0,this.addOutForce(c,v,!0)):this.inCollisionWall=!1}},t.prototype._checkCollisionGlobule=function(t){var i=t.x,o=t.y,e=t.radius,s=t.vx,h=t.vy,r=t.receiveOutForce,n=t.onlyCheckCollision,l=t.fixedPos,a=t.controlledByMouse;if((this.receiveOutForce||this.onlyCheckCollision||r||n)&&Math.hypot(i-this.x,o-this.y)<=e+this.radius&&(s!==this.vx||h!==this.vy)){var u=this.x,c=this.y,v=this.vx,f=this.vy;if(this.receiveOutForce&&r&&!this.fixedPos&&!this.controlledByMouse){var d=this._getOutForce(i,o,s,h),y=d.outForceVX,p=d.outForceVY;this.addOutForce(y,p,!0)}if((this.receiveOutForce||this.onlyCheckCollision)&&(this.inCollisionGlobule=!0,this.inCollisionGlobuleList.push(t)),r&&this.receiveOutForce&&!l&&!a){var m=t._getOutForce(u,c,v,f),x=m.outForceVX,M=m.outForceVY;t.addOutForce(x,M,!0)}(r||n)&&(t.inCollisionGlobule=!0,t.inCollisionGlobuleList.push(this))}},t.prototype._addCollisionLoss=function(){if(this.receiveOutForce&&!this.fixedPos&&0!==this.collisionLossV&&!this.controlledByMouse){var t=this.getXAndYValue(this.collisionLossV,this.vx,this.vy),i=t.x,o=t.y;Math.abs(this.vx)>Math.abs(i)?this.vx-=i:this.vx=0,Math.abs(this.vy)>Math.abs(o)?this.vy-=o:this.vy=0}},t.prototype._addMoveLoss=function(){if(!this.fixedPos&&0!==this.moveLossV&&!this.controlledByMouse){var t=this.getXAndYValue(this.moveLossV,this.vx,this.vy),i=t.x,o=t.y;Math.abs(this.vx)>Math.abs(i)?this.vx-=i:this.vx=0,Math.abs(this.vy)>Math.abs(o)?this.vy-=o:this.vy=0}},t.prototype._checkOverlap=function(t){var i=t.x,o=t.y,e=t.radius,s=t.receiveOutForce,h=t.fixedPos,r=t.controlledByMouse;if(this.receiveOutForce&&s&&(!this.fixedPos||!h)){var n=Math.hypot(i-this.x,o-this.y);if(n+.2<e+this.radius){var l=e+this.radius-n;this.fixedPos||this.controlledByMouse||h||r||(l/=2);var a=0,u=0;this.x===i?(u=l,this.y>o?(this.fixedPos||this.controlledByMouse||(this.y=this.y+u),h||r||(t.y=o-u)):(this.fixedPos||this.controlledByMouse||(this.y=this.y-l),h||r||(t.y=o+l))):this.y===o?(a=l,this.x>i?(this.fixedPos||this.controlledByMouse||(this.x=this.x+a),h||r||(t.x=i-a)):(this.fixedPos||this.controlledByMouse||(this.x=this.x-a),h||r||(t.x=i+a))):this.x>i?(a=l/n*Math.abs(this.x-i),u=l/n*Math.abs(this.y-o),this.y>o?(this.fixedPos||this.controlledByMouse||(this.x=this.x+a,this.y=this.y+u),h||r||(t.x=i-a,t.y=o-u)):(this.fixedPos||this.controlledByMouse||(this.x=this.x+a,this.y=this.y-u),h||r||(t.x=i-a,t.y=o+u))):(a=l/n*Math.abs(this.x-i),u=l/n*Math.abs(this.y-o),this.y>o?(this.fixedPos||this.controlledByMouse||(this.x=this.x-a,this.y=this.y+u),h||r||(t.x=i+a,t.y=o-u)):(this.fixedPos||this.controlledByMouse||(this.x=this.x-a,this.y=this.y-u),h||r||(t.x=i+a,t.y=o+u)))}}},t.prototype._checkOverWall=function(t,i,o,e){if(this.receiveWallForce&&!this.fixedPos){var s=this,h=s.x,r=s.y,n=s.radius;this.resistanceWallDirection.includes("bottom")&&r>i+e-n&&(this.y=i+e-n),this.resistanceWallDirection.includes("top")&&r<n+i&&(this.y=n+i),this.resistanceWallDirection.includes("left")&&h<n+t&&(this.x=n+t),this.resistanceWallDirection.includes("right")&&this.x>t+o-n&&(this.x=t+o-n)}},t.prototype._addGravitation=function(){if(!this.fixedPos&&this.gDirection&&this.gCoefficient&&!this.controlledByMouse)switch(this.gDirection){case"toInit":var t=(this.initX-this.x)*this.gCoefficient,i=(this.initY-this.y)*this.gCoefficient;this.addOutForce(t,i);break;case"toBottom":var o=this.gCoefficient;this.addOutForce(0,o);break;case"toTop":var e=-this.gCoefficient;this.addOutForce(0,e);break;case"toLeft":var s=-this.gCoefficient;this.addOutForce(s,0);break;case"toRight":var h=this.gCoefficient;this.addOutForce(h,0)}},t.prototype.getXAndYValue=function(t,i,o){return{x:t*i/Math.hypot(i,o),y:t*o/Math.hypot(i,o)}},t.prototype._getLineEquation=function(t,i,o,e){var s=(e-i)/(o-t);return{k:s,b:i-s*t}},t.prototype._getCosspoint=function(t,i,o,e,s,h){var r=this._getLineEquation(o,-e,s,-h),n=r.k,l=r.b,a=-1/n,u=(l-(-i-a*t))/(a-n);return{x:u,y:-(n*u+l)}},t}();return i.default=o,i.default}()}));