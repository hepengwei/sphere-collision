!function(i,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.SphereCollision=t():i.SphereCollision=t()}(self,(function(){return function(){"use strict";var i,t={};!function(i){i[i.waitStart=0]="waitStart",i[i.inAnimation=1]="inAnimation",i[i.stop=2]="stop"}(i||(i={}));var s=function(){function t(t,s,e,h,l,r,a,n,c,u){this.ctx=t||null,this.canvas=s||null,this.monitorMousePos=!!h,this.beforeDrawGlobules=l||null,this.afterDrawGlobules=r||null,this.frameId=0,this.animationState=i.waitStart,this.mousePos={mouseX:null,mouseY:null},this.collisionRectX=a||0,this.collisionRectY=n||0,this.collisionRectWidth=c||s.width,this.collisionRectHeight=u||s.height;var v=[];if(e&&e.length>0)for(var f=0,x=e.length;f<x;f++){var d=e[f],y=d.id,m=d.initX,p=d.initY,b=d.vx,F=d.vy,C=d.radius,g=d.color,V=d.alpha,L=d.alphaChangeV,M=d.bgImg,G=d.collisionLossV,O=d.moveLossV,P=d.gDirection,w=d.gCoefficient,_=d.requiredMouseInteraction,X=d.fixedPos,Y=d.receiveOutForce,I=d.receiveWallForce,D=d.onlyCheckCollision,S=d.maxMouseOutForce,k=d.maxMoveV,H=d.beforeDrawGlobule,W=d.afterDrawGlobule,R=d.afterCalculateNextFrameGlobule,A=new o(t,s,y,m,p,b,F,C,g,V,L,M,G,O,P,w,_,X,Y,I,D,S,this.mousePos,k,H,W,R);v.push(A)}if(this.globuleList=v,h){var q=s.getBoundingClientRect(),N=this;s.addEventListener("mousemove",(function(i){var t=i.clientX-q.left,s=i.clientY-q.top;N.mousePos.mouseX=t,N.mousePos.mouseY=s}))}}return t.prototype.start=function(){var t=this;this.animationState=i.inAnimation,t.frameId=requestAnimationFrame((function s(){if(t.animationState===i.inAnimation){var o=t.ctx,e=t.canvas,h=t.globuleList,l=t.beforeDrawGlobules,r=t.afterDrawGlobules,a=t.collisionRectX,n=t.collisionRectY,c=t.collisionRectWidth,u=t.collisionRectHeight,v=e.width,f=e.height;h&&h.length>0&&(l?l&&l(t):o.clearRect(0,0,v,f),h.forEach((function(i,t){i._drawCurrentFrame(h,t,a,n,c,u)})),r&&r(t),h.forEach((function(i){i._initCollisionState()})),h.forEach((function(i,t){i._calculateNextFrame(h,t,a,n,c,u)})),t.frameId=requestAnimationFrame(s))}}))},t.prototype.createGlobule=function(i){var t=i.id,s=i.initX,e=i.initY,h=i.vx,l=i.vy,r=i.radius,a=i.color,n=i.alpha,c=i.alphaChangeV,u=i.bgImg,v=i.collisionLossV,f=i.moveLossV,x=i.gDirection,d=i.gCoefficient,y=i.requiredMouseInteraction,m=i.fixedPos,p=i.receiveOutForce,b=i.receiveWallForce,F=i.onlyCheckCollision,C=i.maxMouseOutForce,g=i.maxMoveV,V=i.beforeDrawGlobule,L=i.afterDrawGlobule,M=i.afterCalculateNextFrameGlobule;return new o(this.ctx,this.canvas,t,s,e,h,l,r,a,n,c,u,v,f,x,d,y,m,p,b,F,C,this.mousePos,g,V,L,M)},t.prototype.updateGlobuleList=function(i){"[object Array]"===Object.prototype.toString.call(i)&&(this.globuleList=i)},t.prototype.stop=function(){this.animationState===i.inAnimation&&(this.animationState=i.stop),this.frameId&&(cancelAnimationFrame(this.frameId),this.frameId=0)},t}(),o=function(){function i(i,t,s,o,e,h,l,r,a,n,c,u,v,f,x,d,y,m,p,b,F,C,g,V,L,M,G){this.id=s,this.ctx=i,this.canvas=t,this.initX=o||0,this.initY=e||0,this.x=this.initX,this.y=this.initY,this.vx=h||0,this.vy=l||0,this.radius=r||10,this.color=a||"#666666",this.alpha="number"==typeof n?n<0?0:n>1?1:n:1,this.alphaChangeV="number"==typeof c?c:0,this.bgImg=u||"",this.collisionLossV=v||0,this.moveLossV=f||0,this.gDirection=x,this.gCoefficient=d||0,this.requiredMouseInteraction=!!y,this.fixedPos=!!m,this.receiveOutForce="boolean"!=typeof p||p,this.receiveWallForce="boolean"!=typeof b||b,this.onlyCheckCollision=!!F,this.maxMouseOutForce=C||null,this.mousePos=g||{mouseX:null,mouseY:null},this.maxMoveV=V||null,this.firstHoverX=null,this.firstHoverY=null,this.outForceLastTime=null,this.inCollisionGlobule=!1,this.inCollisionGlobuleList=[],this.inCollisionWall=!1,this.beforeDrawGlobule=L||null,this.afterDrawGlobule=M||null,this.afterCalculateNextFrameGlobule=G||null}return i.prototype._draw=function(){if(this.ctx.save(),this.ctx.beginPath(),this.bgImg)this.ctx.fillStyle="transparent";else{var i=this.ctx.createRadialGradient(this.x,this.y,0,this.x,this.y,this.radius);i.addColorStop(0,"#ffffff"),i.addColorStop(1,this.color),this.ctx.fillStyle=i}if(this.ctx.globalAlpha=this.alpha,this.ctx.arc(this.x,this.y,this.radius,0,2*Math.PI,!1),this.ctx.fill(),this.bgImg){var t=new Image;t.width=2*this.radius,t.height=2*this.radius,t.src=this.bgImg,this.ctx.drawImage(t,this.x-this.radius,this.y-this.radius,2*this.radius,2*this.radius)}this.ctx.restore()},i.prototype._drawCurrentFrame=function(i,t,s,o,e,h){if(this.receiveOutForce)for(var l=t+1,r=i.length;l<r;l++){var a=i[l];this._checkOverlap(a)}this._checkOverWall(s,o,e,h),this.beforeDrawGlobule&&this.beforeDrawGlobule(this),this._draw(),this.afterDrawGlobule&&this.afterDrawGlobule(this)},i.prototype._calculateNextFrame=function(i,t,s,o,e,h){this._checkHover();for(var l=t+1,r=i.length;l<r;l++){var a=i[l];this._checkCollisionGlobule(a)}if(this._checkCollisionWall(s,o,e,h),this._addGravitation(),this.x+=this.vx,this.y+=this.vy,0!==this.alphaChangeV){var n=this.alpha+this.alphaChangeV;n<0?n=0:n>1&&(n=1),this.alpha=n}this._addMoveLoss(),this.afterCalculateNextFrameGlobule&&this.afterCalculateNextFrameGlobule(this)},i.prototype._initCollisionState=function(){this.inCollisionGlobule=!1,this.inCollisionGlobuleList=[],this.inCollisionWall=!1},i.prototype._getOutForce=function(i,t,s,o,e){void 0===e&&(e=!1);var h=this,l=h.x,r=h.y,a=h.vx,n=h.vy,c=0,u=0,v=Math.hypot(i-l,t-r);if(0!==v&&(c=Math.abs(l-i)/v*s,u=Math.abs(r-t)/v*o),s>0?a>0?c-=a:e||(0===this.collisionLossV?c=2*-this.vx:c-=a):s<0?a<=0?c-=a:e||(0===this.collisionLossV?c=2*-this.vx:c-=a):c=2*-this.vx,o>0?n>=0?u-=n:e||(0===this.collisionLossV?u=2*-this.vy:u-=n):o<0?n<=0?u-=n:e||(0===this.collisionLossV?u=2*-this.vy:u-=n):u=2*-this.vy,e){var f=this.requiredMouseInteraction,x=this.maxMouseOutForce;f&&x&&((c>x||c<-x)&&(c=0),u>x?u=x:u<-x&&(u=-x))}return{outForceVX:c,outForceVY:u}},i.prototype.addOutForce=function(i,t,s){void 0===s&&(s=!1),this.receiveOutForce&&!this.fixedPos&&(this.vx+=i,this.vy+=t,"number"==typeof this.maxMoveV&&this.maxMoveV>=0&&(this.vx>this.maxMoveV?this.vx=this.maxMoveV:this.vx<-this.maxMoveV&&(this.vx=-this.maxMoveV),this.vy>this.maxMoveV?this.vy=this.maxMoveV:this.vy<-this.maxMoveV&&(this.vy=-this.maxMoveV)),s&&(0!==i&&this._addCollisionLoss("x"),0!==t&&this._addCollisionLoss("y")))},i.prototype._checkHover=function(){if(!this.fixedPos&&this.requiredMouseInteraction){var i=this.mousePos,t=i.mouseX,s=i.mouseY;if(null!==t&&null!==s&&Math.hypot(t-this.x,s-this.y)<=this.radius){if(this.outForceLastTime&&(new Date).getTime()-this.outForceLastTime<400)return;if(null!==this.firstHoverX&&null!==this.firstHoverY){var o=t-this.firstHoverX,e=s-this.firstHoverY,h=this._getOutForce(this.firstHoverX,this.firstHoverY,o,e,!0),l=h.outForceVX,r=h.outForceVY;this.addOutForce(l,r),this.outForceLastTime=(new Date).getTime(),this.firstHoverX=null,this.firstHoverY=null}else this.firstHoverX=t,this.firstHoverY=s}}},i.prototype._checkCollisionWall=function(i,t,s,o){if(this.receiveWallForce&&!this.fixedPos){var e=this,h=e.x,l=e.y,r=e.radius,a=e.vx,n=e.vy,c=0,u=0,v=!1;(h<=r+i||h>=i+s-r)&&0!==a&&(c=2*-a,v=!0),(l<=r+t||l>=t+o-r)&&0!==n&&(u=2*-n,v=!0),v?(this.inCollisionWall=!0,this.addOutForce(c,u,!0)):this.inCollisionWall=!1}},i.prototype._checkCollisionGlobule=function(i){var t=i.x,s=i.y,o=i.radius,e=i.vx,h=i.vy,l=i.receiveOutForce,r=i.onlyCheckCollision,a=i.fixedPos;if((this.receiveOutForce||this.onlyCheckCollision||l||r)&&Math.hypot(t-this.x,s-this.y)<=o+this.radius){var n=this.x+(t-this.x)*(this.radius/(this.radius+o)),c=this.y+(s-this.y)*(this.radius/(this.radius+o)),u=!1;if(e!==this.vx&&(u=!0),h!==this.vy&&(u=!0),u){var v=this.vx,f=this.vy;if(this.receiveOutForce&&l&&!this.fixedPos){var x=this._getOutForce(n,c,e,h),d=x.outForceVX,y=x.outForceVY;this.addOutForce(d,y,!0)}if((this.receiveOutForce||this.onlyCheckCollision)&&(this.inCollisionGlobule=!0,this.inCollisionGlobuleList.push(i)),l&&this.receiveOutForce&&!a){var m=i._getOutForce(n,c,v,f),p=m.outForceVX,b=m.outForceVY;i.addOutForce(p,b,!0)}(l||r)&&(i.inCollisionGlobule=!0,i.inCollisionGlobuleList.push(this))}}},i.prototype._addCollisionLoss=function(i){if(this.receiveOutForce&&!this.fixedPos&&0!==this.collisionLossV){var t=this.vx,s=this.vy;"x"===i?t>0?Math.abs(t)>this.collisionLossV?this.vx=t-this.collisionLossV:this.vx=0:t<0&&(Math.abs(t)>this.collisionLossV?this.vx=t+this.collisionLossV:this.vx=0):"y"===i&&(s>0?Math.abs(s)>this.collisionLossV?this.vy=s-this.collisionLossV:this.vy=0:s<0&&(Math.abs(s)>this.collisionLossV?this.vy=s+this.collisionLossV:this.vy=0))}},i.prototype._addMoveLoss=function(){this.fixedPos||0===this.moveLossV||(Math.abs(this.vx)<this.moveLossV?this.vx=0:this.vx>0?this.vx-=this.moveLossV:this.vx+=this.moveLossV,Math.abs(this.vy)<this.moveLossV?this.vy=0:this.vy>0?this.vy-=this.moveLossV:this.vy+=this.moveLossV)},i.prototype._checkOverlap=function(i){var t=i.x,s=i.y,o=i.radius,e=i.receiveOutForce,h=i.fixedPos;if(this.receiveOutForce&&e&&(!this.fixedPos||!h)){var l=Math.hypot(t-this.x,s-this.y);if(l+.2<o+this.radius){var r=o+this.radius-l;this.fixedPos||h||(r/=2);var a=0,n=0;this.x===t?(n=r,this.y>s?(this.fixedPos||(this.y=this.y+n),h||(i.y=s-n)):(this.fixedPos||(this.y=this.y-r),h||(i.y=s+r))):this.y===s?(a=r,this.x>t?(this.fixedPos||(this.x=this.x+a),h||(i.x=t-a)):(this.fixedPos||(this.x=this.x-a),h||(i.x=t+a))):this.x>t?(a=r/l*Math.abs(this.x-t),n=r/l*Math.abs(this.y-s),this.y>s?(this.fixedPos||(this.x=this.x+a,this.y=this.y+n),h||(i.x=t-a,i.y=s-n)):(this.fixedPos||(this.x=this.x+a,this.y=this.y-n),h||(i.x=t-a,i.y=s+n))):(a=r/l*Math.abs(this.x-t),n=r/l*Math.abs(this.y-s),this.y>s?(this.fixedPos||(this.x=this.x-a,this.y=this.y+n),h||(i.x=t+a,i.y=s-n)):(this.fixedPos||(this.x=this.x-a,this.y=this.y-n),h||(i.x=t+a,i.y=s+n)))}}},i.prototype._checkOverWall=function(i,t,s,o){if(this.receiveWallForce&&!this.fixedPos){var e=this,h=e.x,l=e.y,r=e.radius;h<r+i?this.x=r+i:this.x>i+s-r&&(this.x=i+s-r),l<r+t?this.y=r+t:l>t+o-r&&(this.y=t+o-r)}},i.prototype._addGravitation=function(){if(this.receiveOutForce&&!this.fixedPos&&"toInit"===this.gDirection&&this.gCoefficient){var i=(this.initX-this.x)*this.gCoefficient,t=(this.initY-this.y)*this.gCoefficient;this.addOutForce(i,t)}},i}();return t.default=s,t.default}()}));