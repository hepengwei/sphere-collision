!function(t,i){"object"==typeof exports&&"object"==typeof module?module.exports=i():"function"==typeof define&&define.amd?define([],i):"object"==typeof exports?exports.SphereCollision=i():t.SphereCollision=i()}(self,(function(){return function(){"use strict";var t,i={};!function(t){t[t.waitStart=0]="waitStart",t[t.inAnimation=1]="inAnimation",t[t.stop=2]="stop"}(t||(t={}));var o=function(){function i(i,o,s,r){this.ctx=i||null,this.canvas=o||null,this.options={collisionRectX:0,collisionRectY:0,collisionRectWidth:o.width,collisionRectHeight:o.height,monitorMousePos:!1,beforeDrawGlobules:null,afterDrawGlobules:null,onMouseDownCanvas:null,onMouseMoveCanvas:null,onMouseUpCanvas:null,onMouseLeaveCanvas:null},r&&(this.options=Object.assign({},this.options,r)),this.frameId=0,this.animationState=t.waitStart,this.mousePos={mouseX:null,mouseY:null},this.prevMousePos={mouseX:null,mouseY:null},this.isMouseDown=!1,this.mouseDownPos={mouseX:null,mouseY:null};var n=[];if(s&&s.length>0)for(var h=0,a=s.length;h<a;h++){var l=s[h],u=l.id,c=l.initX,v=l.initY,f=l.vx,d=l.vy,y=l.radius,p=l.color,m=l.isPureColor,x=l.alpha,M=l.alphaChangeV,b=l.bgImg,g=l.collisionLossV,C=l.moveLossV,F=l.gDirection,P=l.gCoefficient,L=l.requiredMouseInteraction,w=l.mouseInteractionBehavior,_=l.fixedPos,X=l.receiveOutForce,Y=l.receiveWallForce,G=l.resistanceWallDirection,D=l.onlyCheckCollision,V=l.maxMouseOutForce,I=l.maxMoveV,O=l.beforeDrawGlobule,B=l.afterDrawGlobule,k=l.afterCalculateNextFrameGlobule,W=new e(i,o,u,c,v,f,d,y,p,m,x,M,b,g,C,F,P,L,w,_,X,Y,G,D,V,this.mousePos,I,O,B,k);n.push(W)}if(this.globuleList=n,this.options.monitorMousePos){var E=this;o.addEventListener("mousedown",(function(t){E._updateMouseProperty(t),E.mouseInGlobuleList.forEach((function(t){var i=t.requiredMouseInteraction,o=t.mouseInteractionBehavior;i&&"drag"===o&&(t.vx=0,t.vy=0)})),E.options.onMouseDownCanvas&&E.options.onMouseDownCanvas(t,E)})),o.addEventListener("mousemove",(function(t){E._updateMouseProperty(t),E.isMouseDown&&E.mouseInGlobuleList.forEach((function(t){var i=t.requiredMouseInteraction,o=t.mouseInteractionBehavior;if(i&&"drag"===o){var e=E.mousePos.mouseX-E.prevMousePos.mouseX,s=E.mousePos.mouseY-E.prevMousePos.mouseY;t.x+=e,t.y+=s;var r=t.receiveOutForce,n=t.maxMouseOutForce;if(r){var h=e,a=s;if(n){var l=t.getXAndYValue(n,e,s),u=l.x,c=l.y;h>u?h=u:h<-u&&(h=-u),a>c?a=c:a<-c&&(a=-c)}t.vx=h,t.vy=a}}})),E.options.onMouseMoveCanvas&&E.options.onMouseMoveCanvas(t,E)})),o.addEventListener("mouseup",(function(t){E._updateMouseProperty(t),E.options.onMouseUpCanvas&&E.options.onMouseUpCanvas(t,E)})),o.addEventListener("mouseleave",(function(t){E._updateMouseProperty(t),E.options.onMouseLeaveCanvas&&E.options.onMouseLeaveCanvas(t,E)}))}}return i.prototype.start=function(){var i=this;this.animationState=t.inAnimation,i.frameId=requestAnimationFrame((function o(){if(i.animationState===t.inAnimation){var e=i.ctx,s=i.canvas,r=i.globuleList,n=i.options,h=n.beforeDrawGlobules,a=n.afterDrawGlobules,l=n.collisionRectX,u=n.collisionRectY,c=n.collisionRectWidth,v=n.collisionRectHeight,f=s.width,d=s.height;h?h&&h(i):e.clearRect(0,0,f,d),r.forEach((function(t,i){t._drawCurrentFrame(r,i,l,u,c,v)})),a&&a(i),r.forEach((function(t){t.inCollisionGlobule=!1,t.inCollisionGlobuleList=[],t.inCollisionWall=!1})),r.forEach((function(t,i){t._calculateNextFrame(r,i,l,u,c,v)})),i.frameId=requestAnimationFrame(o)}}))},i.prototype.createGlobule=function(t){var i=t.id,o=t.initX,s=t.initY,r=t.vx,n=t.vy,h=t.radius,a=t.color,l=t.isPureColor,u=t.alpha,c=t.alphaChangeV,v=t.bgImg,f=t.collisionLossV,d=t.moveLossV,y=t.gDirection,p=t.gCoefficient,m=t.requiredMouseInteraction,x=t.mouseInteractionBehavior,M=t.fixedPos,b=t.receiveOutForce,g=t.receiveWallForce,C=t.resistanceWallDirection,F=t.onlyCheckCollision,P=t.maxMouseOutForce,L=t.maxMoveV,w=t.beforeDrawGlobule,_=t.afterDrawGlobule,X=t.afterCalculateNextFrameGlobule;return new e(this.ctx,this.canvas,i,o,s,r,n,h,a,l,u,c,v,f,d,y,p,m,x,M,b,g,C,F,P,this.mousePos,L,w,_,X)},i.prototype.updateGlobuleList=function(t){"[object Array]"===Object.prototype.toString.call(t)&&(this.globuleList=t)},i.prototype.stop=function(){this.animationState===t.inAnimation&&(this.animationState=t.stop),this.frameId&&(cancelAnimationFrame(this.frameId),this.frameId=0)},i.prototype._updateMouseProperty=function(t){if(this.prevMousePos.mouseX=this.mousePos.mouseX,this.prevMousePos.mouseY=this.mousePos.mouseY,"mouseLeave"===t.type)this.mousePos.mouseX=null,this.mousePos.mouseY=null;else{var i=this.canvas.getBoundingClientRect(),o=t.clientX-i.left,e=t.clientY-i.top;this.mousePos.mouseX=o,this.mousePos.mouseY=e}switch(this.mouseInGlobuleList=this._getMouseInGlobuleList(t.type),t.type){case"mousedown":this.isMouseDown=!0,this.mouseDownPos.mouseX=this.mousePos.mouseX,this.mouseDownPos.mouseY=this.mousePos.mouseY,this.mouseInGlobuleList.forEach((function(t){t.controlledByMouse=!0}));break;case"mousemove":default:break;case"mouseup":case"mouseleave":this.isMouseDown=!1,this.mouseDownPos.mouseX=null,this.mouseDownPos.mouseY=null}},i.prototype._getMouseInGlobuleList=function(t){var i=[],o=this;return this.globuleList.forEach((function(e){"mousemove"===t&&"drag"===e.mouseInteractionBehavior&&e.controlledByMouse?i.push(e):(e.controlledByMouse=!1,o._checkMouseInGlobule(e)&&i.push(e))})),i},i.prototype._checkMouseInGlobule=function(t){var i=this.mousePos,o=i.mouseX,e=i.mouseY,s=!1;return null!==o&&null!==e&&Math.hypot(o-t.x,e-t.y)<t.radius&&(s=!0),s},i}(),e=function(){function t(t,i,o,e,s,r,n,h,a,l,u,c,v,f,d,y,p,m,x,M,b,g,C,F,P,L,w,_,X,Y){this.id=o,this.ctx=t,this.canvas=i,this.initX=e||0,this.initY=s||0,this.x=this.initX,this.y=this.initY,this.previousX=null,this.previousY=null,this.vx=r||0,this.vy=n||0,this.radius=h||10,this.color=a||"#666666",this.isPureColor=!!l,this.alpha="number"==typeof u?u<0?0:u>1?1:u:1,this.alphaChangeV="number"==typeof c?c:0,this.bgImg=v||"",this.collisionLossV=f||0,this.moveLossV=d||0,this.gDirection=y,this.gCoefficient=p||0,this.requiredMouseInteraction=!!m,this.mouseInteractionBehavior=x||(this.requiredMouseInteraction?"over":void 0),this.fixedPos=!!M,this.receiveOutForce="boolean"!=typeof b||b,this.receiveWallForce="boolean"!=typeof g||g,this.resistanceWallDirection=C&&C.length>1?C:["bottom","top","left","right"],this.onlyCheckCollision=!!F,this.maxMouseOutForce=P||null,this.mousePos=L||{mouseX:null,mouseY:null},this.maxMoveV=w||null,this.controlledByMouse=!1,this.firstHoverX=null,this.firstHoverY=null,this.outForceLastTime=null,this.inCollisionGlobule=!1,this.inCollisionGlobuleList=[],this.inCollisionWall=!1,this.beforeDrawGlobule=_||null,this.afterDrawGlobule=X||null,this.afterCalculateNextFrameGlobule=Y||null}return t.prototype._draw=function(){if(this.ctx.save(),this.ctx.beginPath(),this.color)if(this.isPureColor)this.ctx.fillStyle=this.color;else{var t=this.ctx.createRadialGradient(this.x,this.y,0,this.x,this.y,this.radius);t.addColorStop(0,"#ffffff"),t.addColorStop(1,this.color),this.ctx.fillStyle=t}if(this.ctx.globalAlpha=this.alpha,this.ctx.arc(this.x,this.y,this.radius,0,2*Math.PI,!1),this.ctx.fill(),this.bgImg){var i=new Image;i.width=2*this.radius,i.height=2*this.radius,i.src=this.bgImg,this.ctx.drawImage(i,this.x-this.radius,this.y-this.radius,2*this.radius,2*this.radius)}this.ctx.restore(),this.previousX=this.x,this.previousY=this.y},t.prototype._drawCurrentFrame=function(t,i,o,e,s,r){if(this.receiveOutForce)for(var n=i+1,h=t.length;n<h;n++){var a=t[n];this._checkOverlap(a)}this._checkOverWall(o,e,s,r),null!==this.previousX&&null!==this.previousY&&this.previousX===this.x&&this.previousY===this.y&&(0!==this.vx&&(this.vx=0),0!==this.vy&&(this.vy=0)),this.beforeDrawGlobule&&this.beforeDrawGlobule(this),this._draw(),this.afterDrawGlobule&&this.afterDrawGlobule(this)},t.prototype._calculateNextFrame=function(t,i,o,e,s,r){this._checkHover();for(var n=i+1,h=t.length;n<h;n++){var a=t[n];this._checkCollisionGlobule(a)}if(this._checkCollisionWall(o,e,s,r),this._addGravitation(),this.controlledByMouse||(this.x+=this.vx,this.y+=this.vy),0!==this.alphaChangeV){var l=this.alpha+this.alphaChangeV;l<0?l=0:l>1&&(l=1),this.alpha=l}this._addMoveLoss(),this.afterCalculateNextFrameGlobule&&this.afterCalculateNextFrameGlobule(this)},t.prototype._getOutForce=function(t,i,o,e,s,r){var n=this,h=n.x,a=n.y,l=n.vx,u=n.vy,c=0,v=0;if(0===l&&0===u){var f=this._getCosspoint(t+o,i+e,t,i,h,a);c=((y=f.x)-t)/2,v=((p=f.y)-i)/2}else if(0===o&&0===e){var d=this._getCosspoint(h+l,a+u,h,a,t,i),y=d.x,p=d.y;s||r?(c=2*-(y-h),v=2*-(p-a)):(c=3*-(y-h)/2,v=3*-(p-a)/2)}else{var m=this._getLineEquation(h,-a,t,-i);if(m){var x=this._getLineEquation(h,-a,h+l,-(a+u));if(x&&x.k===m.k&&x.b===m.b){var M=this._getLineEquation(t,-i,t+o,-(i+e));if(M&&M.k===m.k&&M.b===m.b&&l*o<=0&&u*e<=0)return{outForceVX:-l+o,outForceVY:-u+e}}}else if(0===l&&0===o)return{outForceVX:0,outForceVY:-u+e};var b=this._getCosspoint(t+o,i+e,t,i,h,a);((c=(y=b.x)-t)>0&&l>0||c<0&&l<0)&&(c-=l),((v=(p=b.y)-i)>0&&u>0||v<0&&u<0)&&(v-=u)}return{outForceVX:c,outForceVY:v}},t.prototype._getMouseOutForce=function(t,i){var o=t,e=i,s=this,r=s.requiredMouseInteraction,n=s.mouseInteractionBehavior,h=s.maxMouseOutForce;return r&&"over"===n&&h&&(o>h?o=h:o<-h&&(o=-h),e>h?e=h:e<-h&&(e=-h)),{outForceVX:o,outForceVY:e}},t.prototype.addOutForce=function(t,i,o){if(void 0===o&&(o=!1),!(this.fixedPos||0===t&&0===i)&&(this.vx+=t,this.vy+=i,o&&this._addCollisionLoss(),"number"==typeof this.maxMoveV&&this.maxMoveV>=0&&Math.hypot(this.vx,this.vy)>this.maxMoveV)){var e=this.getXAndYValue(this.maxMoveV,this.vx,this.vy),s=e.x,r=e.y;this.vx=s,this.vy=r}},t.prototype._checkHover=function(){if(!this.fixedPos&&this.requiredMouseInteraction&&"over"===this.mouseInteractionBehavior){var t=this.mousePos,i=t.mouseX,o=t.mouseY;if(null!==i&&null!==o&&Math.hypot(i-this.x,o-this.y)<=this.radius){if(this.outForceLastTime&&(new Date).getTime()-this.outForceLastTime<400)return;if(null!==this.firstHoverX&&null!==this.firstHoverY){var e=i-this.firstHoverX,s=o-this.firstHoverY,r=this._getMouseOutForce(e,s),n=r.outForceVX,h=r.outForceVY;this.addOutForce(n,h),this.outForceLastTime=(new Date).getTime(),this.firstHoverX=null,this.firstHoverY=null}else this.firstHoverX=i,this.firstHoverY=o}}},t.prototype._checkCollisionWall=function(t,i,o,e){if(this.receiveWallForce&&!this.fixedPos){var s=this,r=s.x,n=s.y,h=s.radius,a=s.vx,l=s.vy,u=s.resistanceWallDirection,c=0,v=0,f=!1;u.includes("bottom")&&n>=i+e-h&&l>0&&(v=2*-l,f=!0),u.includes("top")&&n<=h+i&&l<0&&(v=2*-l,f=!0),u.includes("left")&&r<=h+t&&a<0&&(c=2*-a,f=!0),u.includes("right")&&r>=t+o-h&&a>0&&(c=2*-a,f=!0),f?(this.inCollisionWall=!0,this.addOutForce(c,v,!0)):this.inCollisionWall=!1}},t.prototype._checkCollisionGlobule=function(t){var i=t.x,o=t.y,e=t.radius,s=t.vx,r=t.vy,n=t.receiveOutForce,h=t.onlyCheckCollision,a=t.fixedPos,l=t.controlledByMouse;if((this.receiveOutForce||this.onlyCheckCollision||n||h)&&Math.hypot(i-this.x,o-this.y)<=e+this.radius&&(s!==this.vx||r!==this.vy)){var u=this.x,c=this.y,v=this.vx,f=this.vy;if(this.receiveOutForce&&n&&!this.fixedPos&&!this.controlledByMouse){var d=this._getOutForce(i,o,s,r,a,l),y=d.outForceVX,p=d.outForceVY;this.addOutForce(y,p,!0)}if((this.receiveOutForce||this.onlyCheckCollision)&&(this.inCollisionGlobule=!0,this.inCollisionGlobuleList.push(t)),n&&this.receiveOutForce&&!a&&!l){var m=t._getOutForce(u,c,v,f,this.fixedPos,this.controlledByMouse),x=m.outForceVX,M=m.outForceVY;t.addOutForce(x,M,!0)}(n||h)&&(t.inCollisionGlobule=!0,t.inCollisionGlobuleList.push(this))}},t.prototype._addCollisionLoss=function(){if(this.receiveOutForce&&!this.fixedPos&&0!==this.collisionLossV&&!this.controlledByMouse){var t=this.getXAndYValue(this.collisionLossV,this.vx,this.vy),i=t.x,o=t.y;Math.abs(this.vx)>Math.abs(i)?this.vx-=i:this.vx=0,Math.abs(this.vy)>Math.abs(o)?this.vy-=o:this.vy=0}},t.prototype._addMoveLoss=function(){if(!this.fixedPos&&0!==this.moveLossV&&!this.controlledByMouse){var t=this.getXAndYValue(this.moveLossV,this.vx,this.vy),i=t.x,o=t.y;Math.abs(this.vx)>Math.abs(i)?this.vx-=i:this.vx=0,Math.abs(this.vy)>Math.abs(o)?this.vy-=o:this.vy=0}},t.prototype._checkOverlap=function(t){var i=t.x,o=t.y,e=t.radius,s=t.receiveOutForce,r=t.fixedPos,n=t.controlledByMouse;if(this.receiveOutForce&&s&&(!this.fixedPos||!r)){var h=Math.hypot(i-this.x,o-this.y);if(h+.2<e+this.radius){var a=e+this.radius-h;this.fixedPos||this.controlledByMouse||r||n||(a/=2);var l=0,u=0;this.x===i?(u=a,this.y>o?(this.fixedPos||this.controlledByMouse||(this.y=this.y+u),r||n||(t.y=o-u)):(this.fixedPos||this.controlledByMouse||(this.y=this.y-a),r||n||(t.y=o+a))):this.y===o?(l=a,this.x>i?(this.fixedPos||this.controlledByMouse||(this.x=this.x+l),r||n||(t.x=i-l)):(this.fixedPos||this.controlledByMouse||(this.x=this.x-l),r||n||(t.x=i+l))):this.x>i?(l=a/h*Math.abs(this.x-i),u=a/h*Math.abs(this.y-o),this.y>o?(this.fixedPos||this.controlledByMouse||(this.x=this.x+l,this.y=this.y+u),r||n||(t.x=i-l,t.y=o-u)):(this.fixedPos||this.controlledByMouse||(this.x=this.x+l,this.y=this.y-u),r||n||(t.x=i-l,t.y=o+u))):(l=a/h*Math.abs(this.x-i),u=a/h*Math.abs(this.y-o),this.y>o?(this.fixedPos||this.controlledByMouse||(this.x=this.x-l,this.y=this.y+u),r||n||(t.x=i+l,t.y=o-u)):(this.fixedPos||this.controlledByMouse||(this.x=this.x-l,this.y=this.y-u),r||n||(t.x=i+l,t.y=o+u)))}}},t.prototype._checkOverWall=function(t,i,o,e){if(this.receiveWallForce&&!this.fixedPos){var s=this,r=s.x,n=s.y,h=s.radius;this.resistanceWallDirection.includes("bottom")&&n>i+e-h&&(this.y=i+e-h),this.resistanceWallDirection.includes("top")&&n<h+i&&(this.y=h+i),this.resistanceWallDirection.includes("left")&&r<h+t&&(this.x=h+t),this.resistanceWallDirection.includes("right")&&this.x>t+o-h&&(this.x=t+o-h)}},t.prototype._addGravitation=function(){if(!this.fixedPos&&this.gDirection&&this.gCoefficient&&!this.controlledByMouse)switch(this.gDirection){case"toInit":var t=(this.initX-this.x)*this.gCoefficient,i=(this.initY-this.y)*this.gCoefficient;this.addOutForce(t,i);break;case"toBottom":var o=this.gCoefficient;this.addOutForce(0,o);break;case"toTop":var e=-this.gCoefficient;this.addOutForce(0,e);break;case"toLeft":var s=-this.gCoefficient;this.addOutForce(s,0);break;case"toRight":var r=this.gCoefficient;this.addOutForce(r,0)}},t.prototype.getXAndYValue=function(t,i,o){return 0===i&&0===o?{x:0,y:0}:{x:t*i/Math.hypot(i,o),y:t*o/Math.hypot(i,o)}},t.prototype._getLineEquation=function(t,i,o,e){if(t===o)return null;var s=(e-i)/(o-t);return{k:s,b:i-s*t}},t.prototype._getCosspoint=function(t,i,o,e,s,r){var n=this._getLineEquation(o,-e,s,-r);if(n){var h=n.k,a=n.b;if(0===h)return{x:t,y:e};var l=-1/h,u=(a-(-i-l*t))/(l-h);return{x:u,y:-(h*u+a)}}return{x:o,y:i}},t}();return i.default=o,i.default}()}));